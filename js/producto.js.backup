import products from './products-data.js';

// Price mappings
const patchPrices = {
    none: 0,
    liga: 3,
    champions: 5,
    europa: 4,
    premier: 3,
    seriea: 3,
    mundial: 6,
    copamundo: 8,
    conmemorativo: 5
};

let product = null;
let selectedSize = 'L';

document.addEventListener('DOMContentLoaded', () => {
    // Get Product ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = parseInt(urlParams.get('id'));

    // Find Product
    product = products.find(p => p.id === productId);

    if (!product) {
        // Redirect to catalog if not found
        window.location.href = '/pages/catalogo.html';
        return;
    }

    // Apply special pricing rules
    applySpecialPricing(product);
    // Also apply to all products for related items
    products.forEach(p => applySpecialPricing(p));

    // Populate Data
    document.title = `${product.name} - Camisetazo`;
    document.getElementById('breadcrumb-name').textContent = product.name;
    document.getElementById('product-category').textContent = product.category;
    document.getElementById('product-name').textContent = product.name;
    document.getElementById('product-price').textContent = `€${product.price.toFixed(2)}`;

    // Inject Offer Badge
    const categoryTag = document.getElementById('product-category');
    const badge = document.createElement('span');
    badge.className = 'badge-sale';
    badge.textContent = 'OFERTA';
    categoryTag.parentNode.insertBefore(badge, categoryTag);

    if (product.oldPrice) {
        const oldPriceEl = document.getElementById('product-old-price');
        oldPriceEl.textContent = `€${product.oldPrice.toFixed(2)}`;
        oldPriceEl.classList.remove('hidden');
    }

    const mainImg = document.getElementById('main-img');
    mainImg.src = product.image;
    mainImg.alt = product.name;

    // Generate thumbnails for all available product images
    const thumbnailsContainer = document.querySelector('.thumbnails');
    const basePath = product.image.replace('/1_resultado.webp', '');

    // Try to load images 1-4
    const imagePromises = [];
    for (let i = 1; i <= 4; i++) {
        const imagePath = `${basePath}/${i}_resultado.webp`;
        imagePromises.push(
            new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve({ index: i, path: imagePath, exists: true });
                img.onerror = () => resolve({ index: i, path: imagePath, exists: false });
                img.src = imagePath;
            })
        );
    }

    // Wait for all image checks to complete
    let availableImages = [];
    let currentImageIndex = 0;

    Promise.all(imagePromises).then(results => {
        availableImages = results.filter(r => r.exists);

        availableImages.forEach((img, idx) => {
            const thumb = document.createElement('div');
            thumb.className = `thumb ${idx === 0 ? 'active' : ''}`;
            thumb.innerHTML = `<img src="${img.path}" alt="View ${img.index}">`;
            thumb.addEventListener('click', () => {
                currentImageIndex = idx;
                updateMainImage();
            });
            thumbnailsContainer.appendChild(thumb);
        });

        // Arrow navigation
        const prevBtn = document.getElementById('prev-image');
        const nextBtn = document.getElementById('next-image');

        function updateMainImage() {
            mainImg.src = availableImages[currentImageIndex].path;
            document.querySelectorAll('.thumb').forEach((t, i) => {
                t.classList.toggle('active', i === currentImageIndex);
            });
        }

        prevBtn.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex - 1 + availableImages.length) % availableImages.length;
            updateMainImage();
        });

        nextBtn.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex + 1) % availableImages.length;
            updateMainImage();
        });
    });

    // Size selector
    document.querySelectorAll('.size-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedSize = btn.dataset.size;
            updatePreview();
        });
    });

    // Quantity controls
    const qtyInput = document.getElementById('qty-input');
    document.getElementById('qty-minus').addEventListener('click', () => {
        const currentValue = parseInt(qtyInput.value);
        if (currentValue > 1) {
            qtyInput.value = currentValue - 1;
        }
    });

    document.getElementById('qty-plus').addEventListener('click', () => {
        const currentValue = parseInt(qtyInput.value);
        if (currentValue < 10) {
            qtyInput.value = currentValue + 1;
        }
    });

    // Update preview on any change
    document.getElementById('version-select').addEventListener('change', updatePreview);
    document.getElementById('name-input').addEventListener('input', updatePreview);
    document.getElementById('number-input').addEventListener('input', handleDorsalInput);
    document.getElementById('patch-select').addEventListener('change', updatePreview);

    // Add to cart button
    document.getElementById('add-to-cart-btn').addEventListener('click', addToCart);

    // Load related products
    loadRelatedProducts();

    // Initial preview update
    updatePreview();
});

// Apply special pricing logic
function applySpecialPricing(p) {
    const nameLower = p.name.toLowerCase();
    const isKids = nameLower.includes('kids') || nameLower.includes('niño');
    const isRetro = p.name.trim().endsWith('R') || p.league === 'retro';
    const isNBA = p.category === 'nba' || p.league === 'nba';

    // Default to Normal
    let oldPrice = 25.00;
    let newPrice = 19.90;

    if (isNBA) {
        oldPrice = 30.00;
        newPrice = 24.90;
    } else if (isRetro) {
        oldPrice = 30.00;
        newPrice = 24.90;
    } else if (isKids) {
        oldPrice = 27.00;
        newPrice = 21.90;
    }

    // Apply changes
    p.oldPrice = oldPrice;
    p.price = newPrice;
    p.sale = true;
}

// Handle dorsal input with real-time validation (max 2 digits)
function handleDorsalInput(e) {
    let value = e.target.value;

    // Remove any non-digit characters
    value = value.replace(/\D/g, '');

    // Limit to 2 digits
    if (value.length > 2) {
        value = value.slice(0, 2);
    }

    // Ensure value is between 0-99
    if (value !== '') {
        const numValue = parseInt(value);
        if (numValue > 99) {
            value = '99';
        }
    }

    e.target.value = value;
    updatePreview();
}

function updatePreview() {
    if (!product) return;

    const basePrice = product.price;
    let totalPrice = basePrice;
    const details = [];

    // Version
    const version = document.getElementById('version-select').value;
    if (version === 'jugador') {
        totalPrice += 15;
        details.push('Versión Jugador: +€15');
    }

    // Patch
    const patch = document.getElementById('patch-select').value;
    if (patch && patch !== 'none') {
        const patchCost = patchPrices[patch] || 0;
        totalPrice += patchCost;
        const patchName = document.getElementById('patch-select').selectedOptions[0].text;
        details.push(patchName);
    }

    // Name and number
    const name = document.getElementById('name-input').value.trim();
    const number = document.getElementById('number-input').value;
    if (name) {
        details.push(`Nombre: ${name.toUpperCase()}`);
    }
    if (number) {
        details.push(`Dorsal: ${number}`);
    }
    if (selectedSize) {
        details.push(`Talla: ${selectedSize}`);
    }

    // Update preview display
    document.getElementById('preview-base').textContent = `€${basePrice.toFixed(2)}`;
    document.getElementById('preview-list').innerHTML = details.length > 0
        ? details.map(d => `<span>• ${d}</span>`).join('')
        : '<span style="color: var(--text-muted); font-style: italic;">Sin personalizaciones</span>';
    document.getElementById('preview-total').textContent = `€${totalPrice.toFixed(2)}`;
}

function addToCart() {
    const name = document.getElementById('name-input').value.trim();
    const number = document.getElementById('number-input').value;

    // Validation
    if (name && !/^[A-Za-zÀ-ÿ\s]+$/.test(name)) {
        alert('El nombre solo puede contener letras y espacios');
        return;
    }

    if (number) {
        const numValue = parseInt(number);
        if (number.length > 2 || numValue < 0 || numValue > 99 || isNaN(numValue)) {
            alert('El dorsal debe ser un número entre 0 y 99 (máximo 2 dígitos)');
            return;
        }
    }

    // Gather customization data
    const customization = {
        size: selectedSize,
        version: document.getElementById('version-select').value,
        name: name ? name.toUpperCase() : '',
        number: number || '',
        patch: document.getElementById('patch-select').value
    };

    // Calculate total price
    let totalPrice = product.price;
    if (customization.version === 'jugador') totalPrice += 15;
    if (customization.patch && customization.patch !== 'none') {
        totalPrice += patchPrices[customization.patch] || 0;
    }

    // Get quantity
    const quantity = parseInt(document.getElementById('qty-input').value) || 1;

    // Create cart item
    const cartItem = {
        id: product.id,
        name: product.name,
        image: product.image,
        basePrice: product.price,
        price: totalPrice,
        quantity: quantity,
        customization: customization
    };

    // Add to cart (localStorage)
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    const existingIndex = cart.findIndex(item =>
        item.id === cartItem.id &&
        JSON.stringify(item.customization) === JSON.stringify(cartItem.customization)
    );

    if (existingIndex > -1) {
        cart[existingIndex].quantity += quantity;
    } else {
        cart.push(cartItem);
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();

    // Success feedback
    alert(`${product.name} añadido al carrito!\nCantidad: ${quantity}\nTotal: €${(totalPrice * quantity).toFixed(2)}`);
}

function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    const cartBadge = document.getElementById('cart-count');
    if (cartBadge) {
        cartBadge.textContent = totalItems;
    }
}

function loadRelatedProducts() {
    // Logic to find related products:
    // 1. Same League (most relevant)
    // 2. Same Category (fallback)
    // Exclude current product

    let related = products.filter(p => p.id !== product.id && p.league === product.league);

    // If not enough products from same league, add from same category
    if (related.length < 4) {
        const moreRelated = products.filter(p =>
            p.id !== product.id &&
            p.category === product.category &&
            !related.includes(p)
        );
        related = [...related, ...moreRelated];
    }

    // Shuffle and pick 4
    const finalRelated = related.sort(() => Math.random() - 0.5).slice(0, 4);

    const grid = document.getElementById('related-grid');

    // Use the exact same card structure as Tienda for consistency
    grid.innerHTML = finalRelated.map(p => `
        <article class="product-card">
            <div class="product-image">
                <span class="badge-sale">OFERTA</span>
                <a href="/pages/producto.html?id=${p.id}">
                    <img src="${p.image}" alt="${p.name}" loading="lazy">
                </a>
                <button class="btn-quick-view"><i class="fas fa-eye"></i></button>
            </div>
            <div class="product-info">
                <span class="product-category">${p.category}</span>
                <h3 class="product-title">${p.name}</h3>
                <div class="product-price">
                    <span class="price-old">€${p.oldPrice.toFixed(2)}</span>
                    <span class="price">€${p.price.toFixed(2)}</span>
                </div>
            </div>
        </article>
    `).join('');

    // Re-attach quick view listeners if needed (optional for related section but good for consistency)
    // For now, we just ensure the links work, which they do via the <a> tag.
}

// Update cart count on page load
updateCartCount();
